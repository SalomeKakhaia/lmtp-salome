---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# lmtp <img src='man/figures/lmtp.png' align="right" height="139" /></a>

<!-- badges: start -->
[![Build Status](https://travis-ci.com/nt-williams/lmtp.svg?token=DA4a53nWMx6q9LisKdRD&branch=master)](https://travis-ci.com/nt-williams/lmtp)
[![codecov](https://codecov.io/gh/nt-williams/lmtp/branch/master/graph/badge.svg?token=TFQNTischL)](https://codecov.io/gh/nt-williams/lmtp)
[![MIT license](http://img.shields.io/badge/license-MIT-brightgreen.svg)](http://opensource.org/licenses/MIT)
[![Project Status: WIP â€“ Initial development is in progress, but there has not yet been a stable, usable release suitable for the public.](https://www.repostatus.org/badges/latest/wip.svg)](https://www.repostatus.org/#wip)
<!-- badges: end -->

> Cross-Validated, Non-parametric Causal Effects Based on Longitudinal Modified Treatment Policies

[Nick Williams](https://nicholastwilliams.com) and [Ivan Diaz](https://idiaz.xyz)

---

## Installation

`lmtp` can be installed from GitHub with: 

```r
devtools::install_github("nt-williams/lmtp")
```

## Scope

`lmtp` is an R package that provides an estimation framework for the casual effects of longitudinal modified treatment policies (also referred to as stochastic interventions) as described in Diaz, Williams, & Hoffman (2020). Two primary estimators are supported, a targeted maximum likelihood (TML) estimator and a sequentially doubly robust (SDR) estimator (a substitution and an IPW estimator are provided for the sake of being thorough but their use is recommended against in favor of the TML and SDR estimators). In addition to longitudinal effects, point treatments are naturally supported and both binary and continuous outcome (both with censoring) are allowed. `lmtp` is built atop the [`sl3`](https://github.com/tlverse/sl3) package to utilize ensemble machine learning for estimation. 

For an in-depth look at the package's functionality, please consult the accompying [vignette](https://htmlpreview.github.io/?https://github.com/nt-williams/lmtp/blob/master/vignettes/intro-lmtp.html).

### Features

| Feature                         |    Status   |
|---------------------------------|:-----------:|
| Point treatment                 |   &check;   |
| Longitudinal treatment          |   &check;   |
| Modified treatment intervention |   &check;   |
| Static intervention             |   &check;   |
| Dynamic intervention            |   Planned   |
| Continuous treatment            |   &check;   |
| Binary treatment                |   &check;   |
| Missingness in treatment        |             |
| Continuous outcome              |   &check;   |
| Binary outcome                  |   &check;   |
| Censored outcome                |   &check;   |
| Mediation                       |             |
| Super learner                   |   &check;   |
| Clustered data                  |   Planned   |
| Parallel processing             |   &check;   |
| Progress bars                   |   &check;   |

## Example

```{r}
library(lmtp)
library(sl3)
library(future)

# the data: 4 treatment nodes with time varying covariates and a binary outcome
head(sim_t4)
```

We're interested in a treatment policy, `d`, where exposure is decreased by 1 only among subjects whose exposure won't go below 1 if intervened upon. The true population outcome under this policy is about 0.305.

```{r, eval = F}
# our treatment policy function to be applied at all time points
d <- function(a) {
  (a - 1) * (a - 1 >= 1) + a * (a - 1 < 1)
}
```

In addition to specifying a treatment policy, we need to specify our treatment variables, time-varying covariates, and the `sl3` learners to be used in estimation.

```{r, eval = F}
# our treatment nodes, a character vector of length 4
a <- c("A_1", "A_2", "A_3", "A_4")
# our time varying nodes, a list of length 4
time_varying <- list(c("L_1"), c("L_2"), c("L_3"), c("L_4"))
# our sl3 learner stack: the mean, GLM, and random forest
lrnrs <- make_learner_stack(Lrnr_mean, 
                            Lrnr_glm, 
                            Lrnr_ranger)
```

We can now estimate the effect of our treatment policy, `d`. In this example, we'll use the cross-validated TML estimator with 10 folds. To speed up computation, we can use parallel processing supported by the `future` package.

```{r, eval = F}
plan(multiprocess)

lmtp_tmle(sim_t4, a, "Y", time_varying, k = 1, shift = d, 
          learners_outcome = lrnrs, learners_trt = lrnrs, folds = 10)
#> LMTP Estimator: TMLE
#>    Trt. Policy: (d)
#> 
#> Population intervention effect
#>       Estimate: 0.3089
#>     Std. error: 0.0115
#>         95% CI: (0.2863, 0.3315)
```

## Citation

```
# Package citation

# Paper citation
```

## References

Ivan Diaz, Nicholas Williams, & Katherine Hoffman, 2020. *Non-Parametric Causal Effects Based on Longitudinal Modified Policies*.

